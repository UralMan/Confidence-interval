<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" async></script>

# Доверительный интервал   
## Попадание реализации модели в коридор симуляционных значений с доверительным интервалом   
При анализе моделей и их соответствия реальным или симуляционным данным часто используется проверка того, насколько результаты модели попадают в коридор симуляционных значений (simulation envelope). Этот коридор представляет собой доверительный интервал, построенный на основе симуляционных данных. Основная цель теста — понять, насколько модель адекватно воспроизводит эмпирические закономерности.

### Способы тестирования   
1. **Прямой способ** заключается в генерации множества симуляций на основе предполагаемой модели и последующем сравнении наблюдаемых данных с доверительным интервалом ($CI$) симуляций.   
2. **Обратный способ** состоит в построении доверительного интервала на основе эмпирических данных и проверке того, насколько симуляционные значения модели попадают в этот коридор.   
   
Разберём подробно обратный способ.

## Обратный способ   
### Основная идея   
Обратный подход фокусируется на том, чтобы не проверять попадание эмпирических данных в симуляционный коридор, а, наоборот, проверять, насколько модельные симуляции попадают в доверительный интервал, построенный на основе реальных данных.   
Этот метод особенно полезен, когда у нас есть доверительная информация о реальном распределении данных, и мы хотим проверить, насколько симуляции модели соответствуют этому распределению.

### Алгоритм обратного теста   
1. Сбор эмпирических данных   
    Пусть у нас есть выборка реальных данных $\mathbf{X} = \{x\_1, x\_2, …, x\_n\}$   
2. Оценка доверительного интервала по эмпирическим данным   
    - Выбираем уровень доверия $\alpha$ (например, 95% или 99%).   
    - Строим доверительный интервал на основе эмпирического распределения. Это можно сделать несколькими способами:   
        - Классический способ через нормальное приближение:
          $$CI = \left[ \bar{X} - z\_{\alpha/2} \cdot \frac{\sigma}{\sqrt{n}}, \quad \bar{X} + z\_{\alpha/2} \cdot \frac{\sigma}{\sqrt{n}} \right]$$
        - Непараметрический способ через квантильные оценки:
          $$CI = \left[ Q\_{\alpha/2}, \quad Q\_{1-\alpha/2} \right]$$
        - Бутстрэп-метод: построение интервала на основе повторных подвыборок данных.   
3. Генерация симуляционных данных   
    - Модель генерирует M симуляций: $S\_1, S\_2, …, S\_M$.   
    - Для каждой симуляции получаем статистику $S\_j$, аналогичную эмпирической статистике.   
4. Проверка попадания симуляций в доверительный интервал   
    - Для каждого значения $S\_j$ проверяем: $Q\_{\alpha/2} \leq S\_j \leq Q\_{1-\alpha/2}$   
    - Вычисляем долю симуляций, попавших в этот интервал.   
5. Оценка качества модели   
    - Если большая часть симуляционных значений попадает в доверительный интервал, модель можно считать адекватной.   
    - Если значительная часть симуляций выходит за пределы интервала, это говорит о том, что модель не воспроизводит основные свойства реальных данных.   

### Преимущества обратного способа   
- Ориентация на эмпирические данные   
    В отличие от прямого метода, где эмпирические данные проверяются на соответствие модели, здесь модельные симуляции тестируются на соответствие реальным данным.   
- Более точная проверка   
    Этот подход позволяет лучше оценивать соответствие модели реальным данным, особенно в случае сложных распределений, где нормальные приближения плохо работают.
- Гибкость   
    Можно использовать различные методы построения доверительного интервала (параметрические, непараметрические, бутстрэп), что делает этот подход универсальным.  
   
### Пример   
Допустим, у нас есть реальные данные о времени ожидания в очереди (в минутах) для 100 клиентов. Мы хотим проверить, соответствует ли модельная симуляция этих данных.   
1. Эмпирический доверительный интервал   
    - Используем квантильный метод: $CI = [Q\_{2.5\%}, Q\_{97.5\%}]$   
2. Симуляционные данные   
    - Генерируем 1000 симуляций времени ожидания по модели.   
3. Проверка попадания симуляций в $CI$   
    - Вычисляем, какой процент симуляций попал в $[Q\_{2.5\%}, Q\_{97.5\%}]$.   
    - Если более 95% значений попадают в интервал — модель считается адекватной.   
    - Если существенно меньше — модель требует доработки.
   
### Подитог   
Обратный способ тестирования попадания модели в симуляционный коридор с доверительным интервалом основан на том, что мы строим доверительный интервал по эмпирическим данным, а затем проверяем, насколько симуляционные данные модели попадают в этот интервал. Это делает его мощным инструментом для проверки соответствия модели реальным данным, особенно в случаях сложных распределений, где прямой метод может быть менее информативен.   

## Применение обратного способа   
Ниже приведён подробный план применения обратного способа теста на попадание реализации модели в коридор симуляционных значений с доверительным интервалом, а также пример реализации основных шагов на Python.
### Основная идея обратного метода   
В обратном подходе основное внимание уделяется эмпирическим данным:   
- Сначала на основе наблюдаемых (эмпирических) данных строится доверительный интервал для интересующей статистики (например, среднего, медианы, дисперсии и т.п.).
- Затем генерируются симуляционные значения с использованием модели.   
- Наконец определяется, какая доля симуляций попадает в полученный эмпирический доверительный интервал. Если симуляционные результаты модели соответствуют эмпирическим данным, ожидается, что значительная их часть будет лежать внутри интервала.
   
### Основные шаги применения обратного метода   
1. Сбор эмпирических данных.   
    Собирается выборка наблюдаемых значений $\{x\_1, x\_2, \dots, x\_n\}$, по которым будет оцениваться доверительный интервал.   
2. Оценка доверительного интервала по эмпирическим данным.   
    Выбирается уровень доверия (например, 95%). Интервал можно построить различными способами:   
    - Квантильный метод: с помощью процентилей, например, интервал $[Q\_{2.5\%}, Q\_{97.5\%}$] для 95% доверительного уровня.   
    - Параметрический подход: если данные примерно нормально распределены, можно использовать формулу с выборочным средним и стандартной ошибкой.   
    - Бутстрэп: повторная выборка из исходных данных для оценки интервала.   
3. Генерация симуляционных значений модели.   
    Модель используется для проведения M симуляций. Для каждой симуляции вычисляется интересующая статистика (например, среднее значение).   
4. Проверка попадания симуляций в доверительный интервал.   
    Для каждого симуляционного результата проверяется условие:   
    $$Q\_{\alpha/2} \leq S\_j \leq Q\_{1-\alpha/2},$$   
    где $S\_j$ – значение статистики для $j$-й симуляции. Далее вычисляется доля симуляций, удовлетворяющих этому условию.   
5. Оценка качества модели.   
    Если значительная доля симуляций попадает в эмпирический доверительный интервал, модель можно считать адекватной с точки зрения воспроизведения наблюдаемой вариабельности данных. В противном случае модель может требовать доработки.   
   
### Пример реализации на Python   
Ниже приведён пример кода, демонстрирующий основные шаги обратного метода. В данном примере для простоты используются нормальные распределения как для эмпирических данных, так и для симуляций модели.   
```python
import numpy as np
import matplotlib.pyplot as plt

# --- Шаг 1. Сбор эмпирических данных ---
# Здесь мы генерируем пример эмпирических данных (на практике используйте реальные данные)
np.random.seed(42)  # для воспроизводимости
empirical_data = np.random.normal(loc=10, scale=2, size=100)  # 100 наблюдений

# --- Шаг 2. Оценка доверительного интервала по эмпирическим данным ---
alpha = 0.05  # для 95% доверительного интервала
lower_bound = np.percentile(empirical_data, 100 * (alpha/2))
upper_bound = np.percentile(empirical_data, 100 * (1 - alpha/2))
print("Доверительный интервал эмпирических данных: [{:.2f}, {:.2f}]".format(lower_bound, upper_bound))

# --- Шаг 3. Генерация симуляционных значений модели ---
def simulate_model():
    """
    Функция моделирует генерацию одного значения.
    В данном примере предполагается, что модель генерирует данные
    с параметрами, аналогичными эмпирическим данным.
    """
    return np.random.normal(loc=10, scale=2, size=1)[0]

num_simulations = 1000  # число симуляций
simulation_results = np.array([simulate_model() for _ in range(num_simulations)])

# --- Шаг 4. Проверка попадания симуляций в доверительный интервал ---
inside_interval = (simulation_results >= lower_bound) & (simulation_results <= upper_bound)
proportion_inside = np.mean(inside_interval)
print("Доля симуляций, попавших в доверительный интервал: {:.2f}%".format(proportion_inside * 100))

# --- Шаг 5. Визуализация результатов ---
plt.hist(simulation_results, bins=30, alpha=0.7, label='Симуляционные значения')
plt.axvline(lower_bound, color='red', linestyle='dashed', linewidth=2, label='Нижняя граница CI')
plt.axvline(upper_bound, color='green', linestyle='dashed', linewidth=2, label='Верхняя граница CI')
plt.xlabel("Значения")
plt.ylabel("Частота")
plt.title("Попадание симуляций в эмпирический доверительный интервал")
plt.legend()
plt.show()
```
Пояснения к коду:   
- Эмпирические данные:   
    В примере используется нормально распределённая выборка с параметрами `loc=10` и `scale=2`. На практике вместо этого вы будете использовать реальные наблюдения.   
- Доверительный интервал:   
    Интервал строится с помощью процентильного метода. Для 95% интервала берутся 2.5-й и 97.5-й процентили.   
- Симуляции модели:   
    Функция `simulate_model()`  моделирует генерацию одного значения. В цикле производится 1000 симуляций, результаты которых сохраняются в массиве.   
- Проверка попадания:   
    Определяется доля симуляций, значения которых попадают в интервал `[lower_bound, upper_bound]`.   
- Визуализация:   
    Гистограмма симуляционных значений вместе с линиями, обозначающими границы доверительного интервала, позволяет наглядно оценить соответствие модели эмпирическим данным. 
   
## Итог   
Обратный способ тестирования основывается на построении доверительного интервала непосредственно по эмпирическим данным и последующей проверке, насколько симуляционные результаты модели укладываются в этот интервал. Такой подход помогает оценить адекватность модели с точки зрения воспроизведения характеристик реальных данных, и его реализация на Python сводится к последовательному выполнению описанных выше шагов.   
   
